<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VideoHub - 视频分享平台</title>
    <!-- Element Plus 样式 -->
    <link rel="stylesheet" href="//unpkg.com/element-plus/dist/index.css">
    <!-- Element Plus 图标 -->
    <link rel="stylesheet" href="//unpkg.com/@element-plus/icons-vue/dist/index.css">
    <!-- 自定义样式 -->
    <link rel="stylesheet" href="css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;600&display=swap" rel="stylesheet">
    <!-- 添加CSS样式 -->
    <style>
        
        .avatar-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-right: 30px;
        }
        
        .avatar-upload {
            margin-top: 10px;
            text-align: center;
        }
        
        .user-profile-header {
            display: flex;
            align-items: flex-start;
            padding: 20px;
        }
        
        .user-info {
            flex: 1;
        }
        
        .user-info h2 {
            margin-top: 0;
            margin-bottom: 10px;
        }
        
        .user-info p {
            margin: 5px 0;
            color: #666;
        }
        
        /* 视频卡片样式优化 */
        .video-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .video-card {
            border-radius: 8px;
            overflow: hidden;
            transition: transform 0.3s;
            box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.1);
            cursor: pointer;
        }
        
        .video-card:hover {
            transform: translateY(-5px);
        }
        
        .video-cover {
            position: relative;
            width: 100%;
            padding-top: 56.25%; /* 16:9 比例 */
            overflow: hidden;
        }
        
        .video-cover img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .video-duration {
            position: absolute;
            bottom: 8px;
            right: 8px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 12px;
        }
        
        .video-info {
            padding: 12px;
        }
        
        .video-title {
            margin: 0 0 8px 0;
            font-size: 16px;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            line-height: 1.4;
        }
        
        .video-stats {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 5px;
            color: #666;
            font-size: 13px;
        }
        
        .video-stats span {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .video-publish-time {
            color: #999;
            font-size: 12px;
        }
        
        /* ... existing code ... */
        
        /* 消息提醒样式 */
        .message-badge {
            margin-left: 5px;
        }
        
        /* 社交中心样式 */
        .tab-actions {
            margin-bottom: 15px;
            text-align: right;
        }
        
        .loading-container {
            padding: 20px;
        }
        
        /* 好友列表样式 */
        .friends-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
        }
        
        .friend-card {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            height: 100%;
            transition: transform 0.2s;
        }
        
        .friend-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
        }
        
        .friend-info {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 15px;
        }
        
        .friend-details {
            flex: 1;
        }
        
        .friend-details h3 {
            margin: 0 0 5px 0;
            font-size: 16px;
        }
        
        .friend-details p {
            margin: 0;
            color: #999;
            font-size: 12px;
        }
        
        .friend-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        
        /* 好友请求样式 */
        .friend-requests-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .friend-request-card {
            margin-bottom: 10px;
        }
        
        .request-info {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 10px;
        }
        
        .request-details {
            flex: 1;
        }
        
        .request-details h3 {
            margin: 0 0 5px 0;
            font-size: 16px;
        }
        
        .request-details p {
            margin: 0;
            color: #666;
            font-size: 14px;
        }
        
        .request-time {
            color: #999 !important;
            font-size: 12px !important;
            margin-top: 5px !important;
        }
        
        .request-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        
        /* 聊天区域样式 */
        .chat-container {
            display: flex;
            height: 600px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .chat-sidebar {
            width: 300px;
            border-right: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
            background-color: #f9f9f9;
        }
        
        .sidebar-header {
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .sidebar-header h3 {
            margin: 0;
            font-size: 16px;
        }
        
        .chat-room-list {
            overflow-y: auto;
            flex: 1;
        }
        
        .chat-room-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            cursor: pointer;
            transition: background-color 0.2s;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .chat-room-item:hover {
            background-color: #f0f0f0;
        }
        
        .chat-room-item.active {
            background-color: #e6f7ff;
            border-right: 3px solid #1890ff;
        }
        
        .room-avatar {
            margin-right: 12px;
        }
        
        .room-info {
            flex: 1;
            min-width: 0;
        }
        
        .room-name {
            font-weight: 500;
            margin-bottom: 3px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .room-last-message {
            color: #999;
            font-size: 12px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .room-meta {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }
        
        .room-time {
            color: #999;
            font-size: 12px;
            margin-bottom: 5px;
        }
        
        .chat-main {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .chat-header {
            padding: 15px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .chat-header h3 {
            margin: 0;
            font-size: 16px;
        }
        
        .chat-member-count {
            color: #999;
            font-size: 14px;
        }
        
        .chat-messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            background-color: #f5f5f5;
        }
        
        .message-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .message-item {
            display: flex;
            margin-bottom: 15px;
        }
        
        .message-mine {
            flex-direction: row-reverse;
        }
        
        .message-avatar {
            margin: 0 10px;
        }
        
        .message-content {
            max-width: 70%;
        }
        
        .message-mine .message-content {
            align-items: flex-end;
        }
        
        .message-sender {
            font-size: 12px;
            color: #999;
            margin-bottom: 5px;
        }
        
        .message-bubble {
            padding: 10px 15px;
            border-radius: 18px;
            background-color: #fff;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            word-break: break-word;
        }
        
        .message-mine .message-bubble {
            background-color: #e1f3ff;
            border-radius: 18px;
        }
        
        .message-time {
            font-size: 12px;
            color: #999;
            margin-top: 5px;
            text-align: right;
        }
        
        .chat-input {
            padding: 15px;
            border-top: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .chat-input .el-button {
            align-self: flex-end;
        }
        
        /* 消息样式 */
        .message-mine .message-content {
            align-items: flex-end;
        }
        
        /* ... existing code ... */
    </style>
</head>
<body>
    <!-- Vue应用的挂载点 -->
     
    <div id="app"></div>

    <!-- 引入必要的JS -->
    <script src="//unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="//unpkg.com/element-plus/dist/index.full.js"></script>
    <script src="//unpkg.com/axios/dist/axios.min.js"></script>
    
    <!-- 应用程序脚本 -->
    <script>
        // 获取Vue和Element Plus 全局对象
        const { createApp, ref, onMounted } = Vue;
        const { ElMessage } = ElementPlus;
        
        // API基础URL
        const API_BASE_URL = 'http://localhost:8080/api';
        
        // API服务
        const apiService = {
            // 用户相关
            user: {
                login: (username, password) => axios.post(`${API_BASE_URL}/user/login`, { username, password }),
                register: (userData) => axios.post(`${API_BASE_URL}/user/register`, userData),
                getUserInfo: (userId) => axios.get(`${API_BASE_URL}/user/info?user_id=${userId}`),
                uploadAvatar: (formData) => axios.post(`${API_BASE_URL}/user/avatar`, formData, {
                    headers: { 'Content-Type': 'multipart/form-data' }
                }),
                refreshToken: (refreshToken) => axios.post(`${API_BASE_URL}/user/refresh-token`, { refresh_token: refreshToken }),
                validateToken: () => axios.get(`${API_BASE_URL}/user/validate-token`)
            },
            // 视频相关
            video: {
                getList: (page, size) => axios.get(`${API_BASE_URL}/video/list?page=${page}&size=${size}`),
                getHotList: (page, size, timeRange) => axios.get(`${API_BASE_URL}/video/hot?page=${page}&size=${size}&time_range=${timeRange}`),
                getUserVideos: (userId, page, size) => axios.get(`${API_BASE_URL}/video/list?user_id=${userId}&page=${page}&size=${size}`),
                getFollowedVideos: (page, size) => axios.get(`${API_BASE_URL}/video/list?followed=true&page=${page}&size=${size}`),
                getVideoDetail: (videoId) => axios.get(`${API_BASE_URL}/video/detail?video_id=${videoId}`),
                incrementView: (videoId) => axios.post(`${API_BASE_URL}/video/visit`, { video_id: videoId }),
                publish: (formData) => axios.post(`${API_BASE_URL}/video/publish`, formData, {
                    headers: { 'Content-Type': 'multipart/form-data' }
                })
            },
            // 互动相关
            interaction: {
                like: (videoId) => axios.post(`${API_BASE_URL}/interaction/like`, { video_id: videoId }),
                getLikes: (videoId, page, size) => axios.get(`${API_BASE_URL}/interaction/likes?video_id=${videoId}&page=${page}&size=${size}`),
                comment: (videoId, content, parentId = null) => axios.post(`${API_BASE_URL}/interaction/comment`, { 
                    video_id: videoId, 
                    content, 
                    parent_id: parentId 
                }),
                getComments: (videoId, page, size) => axios.get(`${API_BASE_URL}/interaction/comments?video_id=${videoId}&page=${page}&size=${size}`),
                deleteComment: (commentId) => axios.delete(`${API_BASE_URL}/interaction/comment?comment_id=${commentId}`),
                likeComment: (commentId) => axios.post(`${API_BASE_URL}/interaction/comment/like`, { comment_id: commentId })
            },
            // 社交相关
            social: {
                // 私信相关
                sendMessage: (receiverId, content) => axios.post(`${API_BASE_URL}/social/messages`, { receiver_id: receiverId, content }),
                getMessages: (userId, page, size) => axios.get(`${API_BASE_URL}/social/messages?user_id=${userId}&page=${page}&size=${size}`),
                
                // 聊天室相关
                createChatRoom: (name, userIds) => axios.post(`${API_BASE_URL}/social/chat/rooms`, { name, user_ids: userIds }),
                getChatRoom: (roomId) => axios.get(`${API_BASE_URL}/social/chat/rooms/${roomId}`),
                getUserChatRooms: () => axios.get(`${API_BASE_URL}/social/chat/rooms`),
                sendChatMessage: (roomId, content) => axios.post(`${API_BASE_URL}/social/chat/rooms/${roomId}/messages`, { content }),
                getChatMessages: (roomId, page, size) => axios.get(`${API_BASE_URL}/social/chat/rooms/${roomId}/messages?page=${page}&size=${size}`),
                
                // 好友相关
                addFriend: (userId) => axios.post(`${API_BASE_URL}/social/friends`, { user_id: userId }),
                getFriends: (page, size) => axios.get(`${API_BASE_URL}/social/friends?page=${page}&size=${size}`),
                getFriendship: (friendId) => axios.get(`${API_BASE_URL}/social/friends/${friendId}`),
                
                // 好友申请相关
                createFriendRequest: (receiverId, message) => axios.post(`${API_BASE_URL}/social/friend-requests`, { receiver_id: receiverId, message }),
                getFriendRequests: (page, size) => axios.get(`${API_BASE_URL}/social/friend-requests?page=${page}&size=${size}`),
                handleFriendRequest: (requestId, action) => axios.put(`${API_BASE_URL}/social/friend-requests/${requestId}`, { action }),
                
                // 消息状态相关
                markMessageRead: (messageId) => axios.put(`${API_BASE_URL}/social/messages/${messageId}/read`),
                getUnreadCount: () => axios.get(`${API_BASE_URL}/social/messages/unread/count`)
            }
        };
        
        // 请求拦截器设置令牌
        axios.interceptors.request.use(config => {
            // 只负责添加令牌到请求头，不做任何校验
            const token = localStorage.getItem('token');
            if (token) {
                config.headers.Authorization = `Bearer ${token}`;
            }
            return config;
        }, error => {
            return Promise.reject(error);
        });
        
        // 响应拦截器 - 简化版，不处理令牌相关错误
        axios.interceptors.response.use(response => {
            // 记录成功的响应
            console.log('API请求成功:', response.config.url);
            return response.data;
        }, error => {
            // 详细记录错误信息，便于调试
            console.error('API请求错误:', error);
            
            // 提取请求URL，用于判断是否是特殊请求
            const requestUrl = error.config?.url || '';
            const isAvatarUpload = requestUrl.includes('/user/avatar');
            const isVideoUpload = requestUrl.includes('/video/publish');
            
            // 对于特殊的上传操作，不显示通用错误消息
            // 这些操作应该在各自的处理函数中有专门的错误处理
            if (!isAvatarUpload && !isVideoUpload) {
                // 简化错误处理，只显示消息，不处理令牌
                if (error.response && error.response.data && error.response.data.message) {
                    // 显示错误消息，但不处理401登录过期
                    ElMessage.error(error.response.data.message);
                } else if (error.request) {
                    // 请求发送了但没有收到响应
                    console.error('没有收到响应:', error.request);
                    ElMessage.error('网络错误，请检查您的网络连接或后端服务是否正常运行');
                } else {
                    // 请求设置时出了点问题
                    console.error('请求配置错误:', error.message);
                    ElMessage.error('请求错误: ' + error.message);
                }
            } else {
                console.log('特殊请求错误，不显示通用错误消息:', requestUrl);
            }
            
            return Promise.reject(error);
        });
        
        // 定义图标组件
        const iconComponents = {
            House: {
                template: `<svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg"><path fill="currentColor" d="M192 413.952V896h640V413.952L512 147.328 192 413.952zM139.52 374.4l352-293.312a32 32 0 0 1 40.96 0l352 293.312A32 32 0 0 1 896 398.976V928a32 32 0 0 1-32 32H160a32 32 0 0 1-32-32V398.976a32 32 0 0 1 11.52-24.576z"></path></svg>`
            },
            Histogram: {
                template: `<svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg"><path fill="currentColor" d="M416 896V128h192v768H416zm-288 0V448h192v448H128zm576 0V320h192v576H704z"></path></svg>`
            },
            Star: {
                template: `<svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg"><path fill="currentColor" d="m512 747.84 228.16 119.936a6.4 6.4 0 0 0 9.28-6.72l-43.52-254.08 184.512-179.904a6.4 6.4 0 0 0-3.52-10.88l-255.104-37.12L517.76 147.904a6.4 6.4 0 0 0-11.52 0L392.192 379.072l-255.104 37.12a6.4 6.4 0 0 0-3.52 10.88L318.08 606.976l-43.584 254.08a6.4 6.4 0 0 0 9.28 6.72L512 747.84zM313.6 924.48a70.4 70.4 0 0 1-102.144-74.24l37.888-220.928L88.96 472.96A70.4 70.4 0 0 1 128 352.896l221.76-32.256 99.2-200.96a70.4 70.4 0 0 1 126.208 0l99.2 200.96 221.824 32.256a70.4 70.4 0 0 1 39.04 120.064L774.72 629.376l37.888 220.928a70.4 70.4 0 0 1-102.144 74.24L512 820.096l-198.4 104.32z"></path></svg>`
            },
            User: {
                template: `<svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg"><path fill="currentColor" d="M512 512a192 192 0 1 0 0-384 192 192 0 0 0 0 384zm0 64a256 256 0 1 1 0-512 256 256 0 0 1 0 512zm320 320v-96a96 96 0 0 0-96-96H288a96 96 0 0 0-96 96v96a32 32 0 1 1-64 0v-96a160 160 0 0 1 160-160h448a160 160 0 0 1 160 160v96a32 32 0 1 1-64 0z"></path></svg>`
            },
            Lock: {
                template: `<svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg"><path fill="currentColor" d="M224 448a32 32 0 0 0-32 32v384a32 32 0 0 0 32 32h576a32 32 0 0 0 32-32V480a32 32 0 0 0-32-32H224zm0-64h576a96 96 0 0 1 96 96v384a96 96 0 0 1-96 96H224a96 96 0 0 1-96-96V480a96 96 0 0 1 96-96z"></path><path fill="currentColor" d="M512 544a32 32 0 0 1 32 32v192a32 32 0 1 1-64 0V576a32 32 0 0 1 32-32zm192-160v-64a192 192 0 1 0-384 0v64h384zM512 64a256 256 0 0 1 256 256v128H256V320A256 256 0 0 1 512 64z"></path></svg>`
            },
            Message: {
                template: `<svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg"><path fill="currentColor" d="M128 224v512a64 64 0 0 0 64 64h640a64 64 0 0 0 64-64V224H128zm0-64h768a64 64 0 0 1 64 64v512a128 128 0 0 1-128 128H192A128 128 0 0 1 64 736V224a64 64 0 0 1 64-64z"></path><path fill="currentColor" d="M904 224 656.512 506.88a192 192 0 0 1-289.024 0L120 224h784zm-698.944 0 210.56 240.704a128 128 0 0 0 192.704 0L818.944 224H205.056z"></path></svg>`
            },
            VideoPlay: {
                template: `<svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg"><path fill="currentColor" d="M512 64a448 448 0 1 1 0 896 448 448 0 0 1 0-896zm0 832a384 384 0 0 0 0-768 384 384 0 0 0 0 768zm-48-247.616L668.608 512 464 375.616v272.768zm10.624-342.656 249.472 166.336a48 48 0 0 1 0 79.872L474.624 718.272A48 48 0 0 1 400 678.336V345.6a48 48 0 0 1 74.624-39.936z"></path></svg>`
            },
            SwitchButton: {
                template: `<svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg"><path fill="currentColor" d="M352 159.872V230.4a352 352 0 1 0 320 0v-70.528A416.128 416.128 0 0 1 512 960a416 416 0 0 1-160-800.128z"></path><path fill="currentColor" d="M512 64q32 0 32 32v320q0 32-32 32t-32-32V96q0-32 32-32z"></path></svg>`
            },
            Plus: {
                template: `<svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg"><path fill="currentColor" d="M480 480V144a32 32 0 0 1 64 0v336h336a32 32 0 0 1 0 64H544v336a32 32 0 0 1-64 0V544H144a32 32 0 0 1 0-64h336z"></path></svg>`
            },
            View: {
                template: `<svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg"><path fill="currentColor" d="M512 64a448 448 0 1 1 0 896 448 448 0 0 1 0-896zm0 832a384 384 0 0 0 0-768 384 384 0 0 0 0 768zm-48-247.616L668.608 512 464 375.616v272.768zm10.624-342.656 249.472 166.336a48 48 0 0 1 0 79.872L474.624 718.272A48 48 0 0 1 400 678.336V345.6a48 48 0 0 1 74.624-39.936z"></path></svg>`
            },
            ChatDotRound: {
                template: `<svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg"><path fill="currentColor" d="M512 512a192 192 0 1 0 0-384 192 192 0 0 0 0 384zm0 64a256 256 0 1 1 0-512 256 256 0 0 1 0 512zm320 320v-96a96 96 0 0 0-96-96H288a96 96 0 0 0-96 96v96a32 32 0 1 1-64 0v-96a160 160 0 0 1 160-160h448a160 160 0 0 1 160 160v96a32 32 0 1 1-64 0z"></path></svg>`
            },
            Delete: {
                template: `<svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg"><path fill="currentColor" d="M512 512a192 192 0 1 0 0-384 192 192 0 0 0 0 384zm0 64a256 256 0 1 1 0-512 256 256 0 0 1 0 512zm320 320v-96a96 96 0 0 0-96-96H288a96 96 0 0 0-96 96v96a32 32 0 1 1-64 0v-96a160 160 0 0 1 160-160h448a160 160 0 0 1 160 160v96a32 32 0 1 1-64 0z"></path></svg>`
            }
        };

        // 创建应用模板
        const appTemplate = `
        <div>
            <div class="loading-overlay" :class="{ visible: loading }">
                <div class="loading-spinner"></div>
            </div>
            
            <!-- 顶部导航栏 -->
            <el-header class="cute-header">
                <div class="logo">
                    <img src="images/logo.png" class="logo-img" alt="VideoHub Logo">
                    <span class="logo-text">VideoHub</span>
                </div>
                <div class="nav-menu">
                    <el-menu mode="horizontal" :default-active="activeTab" @select="switchTab" class="cute-menu">
                        <el-menu-item index="home">
                            <el-icon><house /></el-icon>
                            首页
                        </el-menu-item>
                        <el-menu-item index="hot">
                            <el-icon><histogram /></el-icon>
                            热门
                        </el-menu-item>
                        <el-menu-item index="follow">
                            <el-icon><star /></el-icon>
                            关注
                        </el-menu-item>
                    </el-menu>
                </div>
                <div class="user-area">
                    <template v-if="!isLoggedIn">
                        <el-button type="primary" @click="showLoginDialog" class="cute-button">登录</el-button>
                        <el-button @click="showRegisterDialog" class="cute-button-outline">注册</el-button>
                    </template>
                    <template v-else>
                        <el-dropdown trigger="click">
                            <div class="user-avatar">
                                <el-avatar :size="40" :src="userInfo?.avatar || 'images/default-avatar.png'"></el-avatar>
                                <span class="username">{{ userInfo?.nickname || userInfo?.username }}</span>
                            </div>
                            <template #dropdown>
                                <el-dropdown-menu>
                                    <el-dropdown-item @click="goToUserCenter">
                                        <el-icon><user /></el-icon> 个人中心
                                    </el-dropdown-item>
                                    <el-dropdown-item @click="showSocialCenter = true">
                                        <el-icon><chat-dot-round /></el-icon> 社交中心
                                        <el-badge v-if="unreadMessageCount > 0" :value="unreadMessageCount" class="message-badge" />
                                    </el-dropdown-item>
                                    <el-dropdown-item @click="logout">
                                        <el-icon><switch-button /></el-icon> 退出登录
                                    </el-dropdown-item>
                                </el-dropdown-menu>
                            </template>
                        </el-dropdown>
                    </template>
                </div>
            </el-header>

            <!-- 主要内容区 -->
            <el-main class="cute-main">
                <div v-if="currentView === 'home'">
                    <div class="page-header">
                        <h2>推荐视频</h2>
                        <el-button type="primary" @click="showUploadDialog" v-if="isLoggedIn" class="cute-button">
                            <el-icon><plus /></el-icon> 上传视频
                        </el-button>
                    </div>
                    
                    <!-- 加载状态 -->
                    <div v-if="homeLoading" class="video-loading">
                        <el-skeleton :rows="3" animated />
                        <el-skeleton :rows="3" animated />
                    </div>
                    
                    <!-- 视频列表 -->
                    <div v-else-if="homeVideos.length > 0" class="video-grid">
                        <div v-for="video in homeVideos" :key="video.id" class="video-card" @click="goToVideo(video.id)">
                            <div class="video-cover">
                                <img :src="getMediaUrl(video.cover_url || 'images/default-cover.jpg', 'cover')" :alt="video.title">
                                <span class="video-duration">{{formatDuration(video.duration)}}</span>
                            </div>
                            <div class="video-info">
                                <h3 class="video-title">{{video.title}}</h3>
                                <div class="video-meta">
                                    <span class="video-author" @click.stop="goToUser(video.author.id)">
                                        <el-avatar :size="24" :src="video.author.avatar"></el-avatar>
                                        {{video.author.nickname}}
                                    </span>
                                    <div class="video-stats">
                                        <span><el-icon><view /></el-icon> {{formatNumber(video.view_count)}}</span>
                                        <span><el-icon><star /></el-icon> {{formatNumber(video.like_count)}}</span>
                                    </div>
                                </div>
                                <div class="video-publish-time">{{formatTime(video.publish_time)}}</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 无内容时显示 -->
                    <el-empty v-else description="暂无视频内容" />
                    
                    <!-- 分页 -->
                    <div class="pagination-container" v-if="homeVideos.length > 0">
                        <el-pagination 
                            background 
                            layout="prev, pager, next" 
                            :total="homeTotal" 
                            :page-size="homePageSize"
                            :current-page="homeCurrentPage"
                            @current-change="handleHomePageChange" />
                    </div>
                </div>
                <div v-else-if="currentView === 'hot'">
                    <div class="page-header">
                        <h2>热门视频</h2>
                        <div class="time-filter">
                            <el-radio-group v-model="hotTimeRange" @change="loadHotVideos">
                                <el-radio-button label="today">今天</el-radio-button>
                                <el-radio-button label="week">本周</el-radio-button>
                                <el-radio-button label="month">本月</el-radio-button>
                                <el-radio-button label="all">全部</el-radio-button>
                            </el-radio-group>
                        </div>
                    </div>
                    
                    <!-- 加载状态 -->
                    <div v-if="hotLoading" class="video-loading">
                        <el-skeleton :rows="3" animated />
                        <el-skeleton :rows="3" animated />
                    </div>
                    
                    <!-- 视频列表 -->
                    <div v-else-if="hotVideos.length > 0" class="video-grid">
                        <div v-for="(video, index) in hotVideos" :key="video.id" class="video-card hot-video-card" @click="goToVideo(video.id)">
                            <div class="video-rank">{{index + 1}}</div>
                            <div class="video-cover">
                                <img :src="getMediaUrl(video.cover_url || 'images/default-cover.jpg', 'cover')" :alt="video.title">
                                <span class="video-duration">{{formatDuration(video.duration)}}</span>
                            </div>
                            <div class="video-info">
                                <h3 class="video-title">{{video.title}}</h3>
                                <div class="video-meta">
                                    <span class="video-author" @click.stop="goToUser(video.author.id)">
                                        <el-avatar :size="24" :src="video.author.avatar"></el-avatar>
                                        {{video.author.nickname}}
                                    </span>
                                    <div class="video-stats">
                                        <span><el-icon><view /></el-icon> {{formatNumber(video.view_count)}}</span>
                                        <span><el-icon><star /></el-icon> {{formatNumber(video.like_count)}}</span>
                                    </div>
                                </div>
                                <div class="video-publish-time">{{formatTime(video.publish_time)}}</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 无内容时显示 -->
                    <el-empty v-else description="暂无热门视频" />
                    
                    <!-- 分页 -->
                    <div class="pagination-container" v-if="hotVideos.length > 0">
                        <el-pagination 
                            background 
                            layout="prev, pager, next" 
                            :total="hotTotal" 
                            :page-size="hotPageSize"
                            :current-page="hotCurrentPage"
                            @current-change="handleHotPageChange" />
                    </div>
                </div>
                <div v-else-if="currentView === 'follow'">
                    <div v-if="isLoggedIn">
                        <div class="page-header">
                            <h2>关注内容</h2>
                        </div>
                        
                        <!-- 加载状态 -->
                        <div v-if="followLoading" class="video-loading">
                            <el-skeleton :rows="3" animated />
                            <el-skeleton :rows="3" animated />
                        </div>
                        
                        <!-- 视频列表 -->
                        <div v-else-if="followVideos.length > 0" class="video-grid">
                            <div v-for="video in followVideos" :key="video.id" class="video-card" @click="goToVideo(video.id)">
                                <div class="video-cover">
                                    <img :src="getMediaUrl(video.cover_url || 'images/default-cover.jpg', 'cover')" :alt="video.title">
                                    <span class="video-duration">{{formatDuration(video.duration)}}</span>
                                </div>
                                <div class="video-info">
                                    <h3 class="video-title">{{video.title}}</h3>
                                    <div class="video-meta">
                                        <span class="video-author" @click.stop="goToUser(video.author.id)">
                                            <el-avatar :size="24" :src="video.author.avatar"></el-avatar>
                                            {{video.author.nickname}}
                                        </span>
                                        <div class="video-stats">
                                            <span><el-icon><view /></el-icon> {{formatNumber(video.view_count)}}</span>
                                            <span><el-icon><star /></el-icon> {{formatNumber(video.like_count)}}</span>
                                        </div>
                                    </div>
                                    <div class="video-publish-time">{{formatTime(video.publish_time)}}</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 无关注内容时显示 -->
                        <el-empty v-else description="暂无关注内容" :image-size="200">
                            <template #description>
                                <p>您还没有关注任何创作者或您关注的创作者尚未发布视频</p>
                            </template>
                            <el-button type="primary" @click="switchTab('home')" class="cute-button">去首页发现更多</el-button>
                        </el-empty>
                        
                        <!-- 分页 -->
                        <div class="pagination-container" v-if="followVideos.length > 0">
                            <el-pagination 
                                background 
                                layout="prev, pager, next" 
                                :total="followTotal" 
                                :page-size="followPageSize"
                                :current-page="followCurrentPage"
                                @current-change="handleFollowPageChange" />
                        </div>
                    </div>
                    <div v-else class="need-login-tip">
                        <el-empty description="请先登录以查看关注内容">
                            <el-button type="primary" @click="showLoginDialog" class="cute-button">立即登录</el-button>
                        </el-empty>
                    </div>
                </div>
                <div v-else-if="currentView === 'user'" class="user-center">
                    <div class="page-header">
                        <h2>个人中心</h2>
                    </div>
                    
                    <el-card class="user-profile-card">
                        <div class="user-profile-header">
                            <div class="avatar-container">
                                <el-avatar :size="100" :src="userInfo?.avatar || 'images/default-avatar.png'"></el-avatar>
                                <div class="avatar-upload">
                                    <el-upload
                                        action="#"
                                        :http-request="handleAvatarUpload"
                                        :show-file-list="false"
                                        accept="image/*"
                                        class="avatar-uploader">
                                        <el-button size="small" type="primary" style="margin-top: 10px;">更换头像</el-button>
                                    </el-upload>
                                </div>
                            </div>
                            <div class="user-info">
                                <h2>{{ userInfo?.nickname || userInfo?.username }}</h2>
                                <p>ID: {{ userInfo?.id }}</p>
                                <p>注册时间: {{ formatTime(userInfo?.created_at) }}</p>
                            </div>
                        </div>
                        
                        <el-tabs>
                            <el-tab-pane label="我的视频">
                                <div v-if="userVideosLoading" class="video-loading">
                                    <el-skeleton :rows="3" animated />
                                </div>
                                <div v-else-if="userVideos.length > 0" class="video-grid">
                                    <div v-for="video in userVideos" :key="video.id" class="video-card" @click="goToVideo(video.id)">
                                        <div class="video-cover">
                                            <img :src="getMediaUrl(video.cover_url || 'images/default-cover.jpg', 'cover')" :alt="video.title">
                                            <span class="video-duration">{{formatDuration(video.duration)}}</span>
                                        </div>
                                        <div class="video-info">
                                            <h3 class="video-title">{{video.title}}</h3>
                                            <div class="video-stats">
                                                <span><el-icon><view /></el-icon> {{formatNumber(video.view_count)}}</span>
                                                <span><el-icon><star /></el-icon> {{formatNumber(video.like_count)}}</span>
                                            </div>
                                            <div class="video-publish-time">{{formatTime(video.publish_time)}}</div>
                                        </div>
                                    </div>
                                </div>
                                <el-empty v-else description="您还没有上传过视频" />
                                
                                <!-- 添加分页控件 -->
                                <div class="pagination-container" v-if="userVideos.length > 0">
                                    <el-pagination 
                                        background 
                                        layout="prev, pager, next" 
                                        :total="userTotal" 
                                        :page-size="userPageSize"
                                        :current-page="userCurrentPage"
                                        @current-change="handleUserPageChange" />
                                </div>
                            </el-tab-pane>
                            <el-tab-pane label="我的收藏">
                                <el-empty description="收藏功能正在开发中" />
                            </el-tab-pane>
                            <el-tab-pane label="账号设置">
                                <el-form :model="profileForm" label-width="80px">
                                    <el-form-item label="用户名">
                                        <el-input v-model="profileForm.username" disabled></el-input>
                                    </el-form-item>
                                    <el-form-item label="昵称">
                                        <el-input v-model="profileForm.nickname" placeholder="设置昵称"></el-input>
                                    </el-form-item>
                                    <el-form-item label="邮箱">
                                        <el-input v-model="profileForm.email" placeholder="设置邮箱"></el-input>
                                    </el-form-item>
                                    <el-form-item>
                                        <el-button type="primary" @click="updateProfile">保存修改</el-button>
                                    </el-form-item>
                                </el-form>
                            </el-tab-pane>
                        </el-tabs>
                    </el-card>
                </div>
            </el-main>

            <!-- 视频详情页 -->
            <div v-if="showVideoDetail" class="video-detail-overlay">
                <div class="video-detail-container">
                    <div class="video-detail-header">
                        <el-button icon="ArrowLeft" @click="closeVideoDetail" text>返回</el-button>
                        <h2>{{currentVideo.title}}</h2>
                    </div>
                    <div class="video-detail-content">
                        <!-- 视频播放器 -->
                        <div class="video-player-container">
                            <video 
                                ref="videoPlayer" 
                                class="video-player" 
                                controls 
                                autoplay 
                                :src="currentVideo.url"
                                @timeupdate="onVideoTimeUpdate"
                                @ended="onVideoEnded"></video>
                        </div>
                        
                        <!-- 视频信息 -->
                        <div class="video-detail-info">
                            <h1 class="video-detail-title">{{currentVideo.title}}</h1>
                            <div class="video-detail-stats">
                                <span><el-icon><view /></el-icon> {{formatNumber(currentVideo.view_count)}} 次观看</span>
                                <span><el-icon><clock /></el-icon> {{formatTime(currentVideo.publish_time)}}</span>
                            </div>
                            <div class="video-detail-actions">
                                <el-button 
                                    :type="currentVideo.is_liked ? 'primary' : 'default'" 
                                    @click="likeVideo(currentVideo.id)" 
                                    :loading="likeLoading">
                                    <el-icon><star /></el-icon>
                                    {{currentVideo.is_liked ? '已赞' : '点赞'}} {{formatNumber(currentVideo.like_count)}}
                                </el-button>
                                <el-button @click="focusCommentInput">
                                    <el-icon><chat-round /></el-icon>
                                    评论 {{formatNumber(currentVideo.comment_count)}}
                                </el-button>
                                <el-button @click="shareVideo">
                                    <el-icon><share /></el-icon>
                                    分享
                                </el-button>
                            </div>
                            
                            <!-- 作者信息 -->
                            <div class="video-author-info">
                                <div class="author-header">
                                    <el-avatar :size="48" :src="currentVideo.author?.avatar || 'images/default-avatar.png'"></el-avatar>
                                    <div class="author-details">
                                        <h3 @click="goToUser(currentVideo.author?.id)">{{currentVideo.author?.nickname}}</h3>
                                        <p>{{formatNumber(currentVideo.author?.follower_count || 0)}} 粉丝</p>
                                    </div>
                                    <el-button 
                                        v-if="isLoggedIn && currentVideo.author?.id !== userInfo.id"
                                        :type="currentVideo.author?.is_followed ? 'default' : 'primary'" 
                                        @click="toggleFollow(currentVideo.author?.id)">
                                        {{currentVideo.author?.is_followed ? '已关注' : '关注'}}
                                    </el-button>
                                </div>
                                <div class="video-description">
                                    <p>{{currentVideo.description}}</p>
                                </div>
                            </div>
                            
                            <!-- 评论区 -->
                            <div class="video-comments">
                                <h3>评论 ({{currentVideo.comment_count}})</h3>
                                
                                <!-- 评论输入框 -->
                                <div class="comment-input">
                                    <el-avatar :size="40" :src="userInfo?.avatar || 'images/default-avatar.png'"></el-avatar>
                                    <el-input 
                                        v-model="commentContent" 
                                        ref="commentInput"
                                        placeholder="添加评论..." 
                                        :disabled="!isLoggedIn" 
                                        @focus="!isLoggedIn && showLoginDialog()">
                                    </el-input>
                                    <el-button 
                                        type="primary" 
                                        @click="submitComment" 
                                        :disabled="!isLoggedIn || !commentContent.trim()" 
                                        :loading="commentLoading">
                                        发布
                                    </el-button>
                                </div>
                                
                                <!-- 评论列表 -->
                                <div v-if="commentsLoading" class="comments-loading">
                                    <el-skeleton :rows="3" animated />
                                </div>
                                <div v-else-if="comments.length === 0" class="no-comments">
                                    <el-empty description="暂无评论，来发表第一条评论吧！" :image-size="100"></el-empty>
                                </div>
                                <div v-else class="comment-list">
                                    <div v-for="comment in comments" :key="comment.id" class="comment-item">
                                        <el-avatar :size="40" :src="comment.user.avatar || 'images/default-avatar.png'"></el-avatar>
                                        <div class="comment-content">
                                            <div class="comment-header">
                                                <span class="comment-author">{{comment.user.nickname}}</span>
                                                <span class="comment-time">{{formatTime(comment.create_time)}}</span>
                                            </div>
                                            <p class="comment-text">{{comment.content}}</p>
                                            <div class="comment-actions">
                                                <el-button 
                                                    text 
                                                    size="small" 
                                                    :type="comment.is_liked ? 'primary' : 'default'"
                                                    @click="likeComment(comment.id)">
                                                    <el-icon><thumbs-up /></el-icon> {{comment.is_liked ? '已赞' : '赞'}} {{formatNumber(comment.like_count)}}
                                                </el-button>
                                                <el-button 
                                                    text 
                                                    size="small" 
                                                    @click="replyComment(comment)">
                                                    <el-icon><chat-line-round /></el-icon> 回复
                                                </el-button>
                                                <el-button 
                                                    v-if="isLoggedIn && (userInfo.id === comment.user.id || userInfo.id === currentVideo.author?.id)"
                                                    text 
                                                    size="small" 
                                                    type="danger"
                                                    @click="deleteComment(comment.id)">
                                                    <el-icon><delete /></el-icon> 删除
                                                </el-button>
                                            </div>
                                            
                                            <!-- 子评论 -->
                                            <div v-if="comment.children && comment.children.length > 0" class="sub-comments">
                                                <div v-for="subComment in comment.children" :key="subComment.id" class="sub-comment-item">
                                                    <el-avatar :size="32" :src="subComment.user.avatar || 'images/default-avatar.png'"></el-avatar>
                                                    <div class="sub-comment-content">
                                                        <div class="comment-header">
                                                            <span class="comment-author">{{subComment.user.nickname}}</span>
                                                            <span v-if="subComment.reply_to" class="reply-to">回复 {{subComment.reply_to.nickname}}</span>
                                                            <span class="comment-time">{{formatTime(subComment.create_time)}}</span>
                                                        </div>
                                                        <p class="comment-text">{{subComment.content}}</p>
                                                        <div class="comment-actions">
                                                            <el-button 
                                                                text 
                                                                size="small" 
                                                                :type="subComment.is_liked ? 'primary' : 'default'"
                                                                @click="likeComment(subComment.id)">
                                                                <el-icon><thumbs-up /></el-icon> {{subComment.is_liked ? '已赞' : '赞'}} {{formatNumber(subComment.like_count)}}
                                                            </el-button>
                                                            <el-button 
                                                                text 
                                                                size="small" 
                                                                @click="replyComment(subComment, comment.id)">
                                                                <el-icon><chat-line-round /></el-icon> 回复
                                                            </el-button>
                                                            <el-button 
                                                                v-if="isLoggedIn && (userInfo.id === subComment.user.id || userInfo.id === currentVideo.author?.id)"
                                                                text 
                                                                size="small" 
                                                                type="danger"
                                                                @click="deleteComment(subComment.id)">
                                                                <el-icon><delete /></el-icon> 删除
                                                            </el-button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- 评论分页 -->
                                <div class="pagination-container" v-if="comments.length > 0">
                                    <el-pagination 
                                        background 
                                        layout="prev, pager, next" 
                                        :total="commentTotal" 
                                        :page-size="commentPageSize"
                                        :current-page="commentCurrentPage"
                                        @current-change="handleCommentPageChange" />
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 视频分享对话框 -->
            <el-dialog v-model="shareDialogVisible" title="分享视频" width="400px" custom-class="cute-dialog">
                <div class="share-content">
                    <div class="share-link">
                        <el-input v-model="shareLink" readonly>
                            <template #append>
                                <el-button @click="copyShareLink">复制</el-button>
                            </template>
                        </el-input>
                    </div>
                    <div class="share-platforms">
                        <h4>分享到</h4>
                        <div class="platform-icons">
                            <el-button circle @click="shareToQQ"><i class="platform-icon qq-icon"></i></el-button>
                            <el-button circle @click="shareToWechat"><i class="platform-icon wechat-icon"></i></el-button>
                            <el-button circle @click="shareToWeibo"><i class="platform-icon weibo-icon"></i></el-button>
                        </div>
                    </div>
                </div>
            </el-dialog>
            
            <!-- 视频上传对话框 -->
            <el-dialog v-model="uploadDialogVisible" title="上传视频" width="600px" custom-class="cute-dialog upload-dialog">
                <div class="upload-container">
                    <div v-if="uploadStep === 1" class="upload-step">
                        <el-upload
                            class="video-upload"
                            drag
                            action="#"
                            :http-request="handleVideoUpload"
                            :before-upload="beforeVideoUpload"
                            :show-file-list="false"
                            accept="video/*">
                            <el-icon class="el-icon--upload"><upload-filled /></el-icon>
                            <div class="el-upload__text">
                                将视频拖到此处，或<em>点击上传</em>
                            </div>
                            <template #tip>
                                <div class="el-upload__tip">
                                    支持mp4、webm等格式，文件大小不超过500MB
                                </div>
                            </template>
                        </el-upload>
                        
                        <div v-if="videoUploading" class="upload-progress">
                            <el-progress :percentage="uploadProgress" :stroke-width="8" status="warning" />
                            <span class="progress-text">正在上传 {{uploadProgress}}%</span>
                        </div>
                    </div>
                    
                    <div v-else-if="uploadStep === 2" class="upload-step">
                        <el-form :model="videoForm" label-width="80px">
                            <el-form-item label="标题" required>
                                <el-input v-model="videoForm.title" placeholder="请输入视频标题"></el-input>
                            </el-form-item>
                            <el-form-item label="封面">
                                <div class="cover-preview" v-if="videoForm.coverUrl">
                                    <img :src="videoForm.coverUrl" alt="封面预览">
                                </div>
                                <el-upload
                                    class="cover-upload"
                                    action="#"
                                    :http-request="handleCoverUpload"
                                    :show-file-list="false"
                                    accept="image/*">
                                    <el-button type="primary">{{videoForm.coverUrl ? '更换封面' : '上传封面'}}</el-button>
                                </el-upload>
                                <div class="el-upload__tip" v-if="!videoForm.coverUrl">
                                    如不上传，系统将自动截取视频封面
                                </div>
                            </el-form-item>
                            <el-form-item label="描述">
                                <el-input 
                                    v-model="videoForm.description" 
                                    type="textarea" 
                                    :rows="4"
                                    placeholder="请输入视频描述"></el-input>
                            </el-form-item>
                            <el-form-item label="标签">
                                <el-select
                                    v-model="videoForm.tags"
                                    multiple
                                    filterable
                                    allow-create
                                    default-first-option
                                    :reserve-keyword="false"
                                    placeholder="请选择标签（可创建）"
                                    style="width: 100%">
                                    <el-option
                                        v-for="tag in availableTags"
                                        :key="tag"
                                        :label="tag"
                                        :value="tag">
                                    </el-option>
                                </el-select>
                            </el-form-item>
                        </el-form>
                    </div>
                </div>
                
                <template #footer>
                    <div class="dialog-footer">
                        <el-button @click="cancelUpload" class="cute-button-text">取消</el-button>
                        <el-button v-if="uploadStep === 1" type="primary" @click="nextStep" :disabled="!videoForm.videoUrl" class="cute-button">
                            下一步
                        </el-button>
                        <el-button v-else type="primary" @click="publishVideo" :loading="publishLoading" :disabled="!videoForm.title" class="cute-button">
                            发布
                        </el-button>
                    </div>
                </template>
            </el-dialog>

            <!-- 登录对话框 -->
            <el-dialog v-model="loginDialogVisible" title="登录" width="400px" custom-class="cute-dialog">
                <el-form :model="loginForm" :rules="loginRules" label-width="0">
                    <el-form-item prop="username">
                        <el-input v-model="loginForm.username" placeholder="用户名">
                            <template #prefix>
                                <el-icon><user /></el-icon>
                            </template>
                        </el-input>
                    </el-form-item>
                    <el-form-item prop="password">
                        <el-input v-model="loginForm.password" type="password" placeholder="密码" show-password>
                            <template #prefix>
                                <el-icon><lock /></el-icon>
                            </template>
                        </el-input>
                    </el-form-item>
                </el-form>
                <template #footer>
                    <div class="dialog-footer">
                        <el-button @click="loginDialogVisible = false" class="cute-button-text">取消</el-button>
                        <el-button type="primary" @click="login" :loading="loginLoading" class="cute-button">登录</el-button>
                    </div>
                    <div class="register-link">
                        还没有账号？<el-button type="text" @click="switchToRegister" class="cute-link">立即注册</el-button>
                    </div>
                </template>
            </el-dialog>

            <!-- 注册对话框 -->
            <el-dialog v-model="registerDialogVisible" title="注册" width="400px" custom-class="cute-dialog">
                <el-form :model="registerForm" :rules="registerRules" label-width="0">
                    <el-form-item prop="username">
                        <el-input v-model="registerForm.username" placeholder="用户名">
                            <template #prefix>
                                <el-icon><user /></el-icon>
                            </template>
                        </el-input>
                    </el-form-item>
                    <el-form-item prop="password">
                        <el-input v-model="registerForm.password" type="password" placeholder="密码" show-password>
                            <template #prefix>
                                <el-icon><lock /></el-icon>
                            </template>
                        </el-input>
                    </el-form-item>
                    <el-form-item prop="confirmPassword">
                        <el-input v-model="registerForm.confirmPassword" type="password" placeholder="确认密码" show-password>
                            <template #prefix>
                                <el-icon><lock /></el-icon>
                            </template>
                        </el-input>
                    </el-form-item>
                    <el-form-item prop="email">
                        <el-input v-model="registerForm.email" placeholder="邮箱（选填）">
                            <template #prefix>
                                <el-icon><message /></el-icon>
                            </template>
                        </el-input>
                    </el-form-item>
                    <el-form-item prop="nickname">
                        <el-input v-model="registerForm.nickname" placeholder="昵称（选填）">
                            <template #prefix>
                                <el-icon><user /></el-icon>
                            </template>
                        </el-input>
                    </el-form-item>
                </el-form>
                <template #footer>
                    <div class="dialog-footer">
                        <el-button @click="registerDialogVisible = false" class="cute-button-text">取消</el-button>
                        <el-button type="primary" @click="register" :loading="registerLoading" class="cute-button">注册</el-button>
                    </div>
                    <div class="login-link">
                        已有账号？<el-button type="text" @click="switchToLogin" class="cute-link">立即登录</el-button>
                    </div>
                </template>
            </el-dialog>

            <!-- 社交中心对话框 -->
            <el-dialog v-model="showSocialCenter" title="社交中心" width="80%" :before-close="closeSocialCenter">
                <el-tabs v-model="activeSocialTab">
                    <!-- 好友列表标签页 -->
                    <el-tab-pane label="我的好友" name="friends">
                        <div class="tab-actions">
                            <el-button type="primary" size="small" @click="showFriendRequestDialog = true">
                                <el-icon><plus /></el-icon> 添加好友
                            </el-button>
                        </div>
                        
                        <div v-if="friendsLoading" class="loading-container">
                            <el-skeleton :rows="3" animated />
                        </div>
                        <el-empty v-else-if="friendsList.length === 0" description="您还没有好友，去添加一些朋友吧！" />
                        <div v-else class="friends-list">
                            <el-card v-for="friend in friendsList" :key="friend.id" class="friend-card">
                                <div class="friend-info">
                                    <el-avatar :size="50" :src="friend.avatar || 'images/default-avatar.png'"></el-avatar>
                                    <div class="friend-details">
                                        <h3>{{ friend.nickname || friend.username }}</h3>
                                        <p>{{ formatTime(friend.last_interaction_time) }}</p>
                                    </div>
                                </div>
                                <div class="friend-actions">
                                    <el-button type="primary" size="small" @click="startChat(friend.id)">
                                        <el-icon><chat-dot-round /></el-icon> 发消息
                                    </el-button>
                                    <el-button type="danger" size="small" @click="removeFriend(friend.id)">
                                        <el-icon><delete /></el-icon> 删除
                                    </el-button>
                                </div>
                            </el-card>
                        </div>
                        
                        <!-- 分页控件 -->
                        <div class="pagination-container" v-if="friendsList.length > 0">
                            <el-pagination 
                                background 
                                layout="prev, pager, next" 
                                :total="friendsTotal" 
                                :page-size="friendsPageSize"
                                :current-page="friendsCurrentPage"
                                @current-change="handleFriendsPageChange" />
                        </div>
                    </el-tab-pane>
                    
                    <!-- 好友请求标签页 -->
                    <el-tab-pane label="好友请求" name="requests">
                        <div v-if="friendRequestsLoading" class="loading-container">
                            <el-skeleton :rows="3" animated />
                        </div>
                        <el-empty v-else-if="friendRequests.length === 0" description="没有待处理的好友请求" />
                        <div v-else class="friend-requests-list">
                            <el-card v-for="request in friendRequests" :key="request.id" class="friend-request-card">
                                <div class="request-info">
                                    <el-avatar :size="50" :src="request.sender.avatar || 'images/default-avatar.png'"></el-avatar>
                                    <div class="request-details">
                                        <h3>{{ request.sender.nickname || request.sender.username }}</h3>
                                        <p>{{ request.message || '请求添加您为好友' }}</p>
                                        <p class="request-time">{{ formatTime(request.created_at) }}</p>
                                    </div>
                                </div>
                                <div class="request-actions">
                                    <el-button type="primary" size="small" @click="handleFriendRequest(request.id, 'accept')">
                                        接受
                                    </el-button>
                                    <el-button size="small" @click="handleFriendRequest(request.id, 'reject')">
                                        拒绝
                                    </el-button>
                                </div>
                            </el-card>
                        </div>
                    </el-tab-pane>
                    
                    <!-- 聊天室标签页 -->
                    <el-tab-pane label="聊天" name="chat">
                        <div class="chat-container">
                            <div class="chat-sidebar">
                                <div class="sidebar-header">
                                    <h3>聊天列表</h3>
                                    <el-button size="small" @click="showCreateChatRoomDialog = true">
                                        <el-icon><plus /></el-icon> 新建聊天
                                    </el-button>
                                </div>
                                
                                <div v-if="chatRoomsLoading" class="loading-container">
                                    <el-skeleton :rows="3" animated />
                                </div>
                                <el-empty v-else-if="chatRooms.length === 0" description="没有聊天记录" />
                                <div v-else class="chat-room-list">
                                    <div 
                                        v-for="room in chatRooms" 
                                        :key="room.id" 
                                        class="chat-room-item" 
                                        :class="{ active: currentChatRoom && currentChatRoom.id === room.id }"
                                        @click="selectChatRoom(room)">
                                        <div v-if="room.is_group" class="room-avatar group-avatar">
                                            <el-avatar :size="40" :src="'images/group-chat.png'"></el-avatar>
                                        </div>
                                        <div v-else class="room-avatar">
                                            <el-avatar :size="40" :src="room.other_user?.avatar || 'images/default-avatar.png'"></el-avatar>
                                        </div>
                                        <div class="room-info">
                                            <div class="room-name">{{ room.name || room.other_user?.nickname || room.other_user?.username }}</div>
                                            <div class="room-last-message">{{ room.last_message?.content || '暂无消息' }}</div>
                                        </div>
                                        <div class="room-meta">
                                            <div class="room-time">{{ formatTime(room.last_message?.created_at) }}</div>
                                            <el-badge v-if="room.unread_count > 0" :value="room.unread_count" />
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="chat-main">
                                <template v-if="currentChatRoom">
                                    <div class="chat-header">
                                        <h3>{{ currentChatRoom.name || currentChatRoom.other_user?.nickname || currentChatRoom.other_user?.username }}</h3>
                                        <span class="chat-member-count" v-if="currentChatRoom.is_group">
                                            {{ currentChatRoom.member_count || 0 }} 名成员
                                        </span>
                                    </div>
                                    
                                    <div class="chat-messages" ref="chatMessagesContainer">
                                        <div v-if="chatMessagesLoading" class="loading-container">
                                            <el-skeleton :rows="3" animated />
                                        </div>
                                        <el-empty v-else-if="chatMessages.length === 0" description="暂无消息，开始聊天吧！" />
                                        <div v-else class="message-list">
                                            <div 
                                                v-for="message in chatMessages" 
                                                :key="message.id" 
                                                class="message-item"
                                                :class="{ 'message-mine': message.sender_id === userInfo.id }">
                                                <div class="message-avatar">
                                                    <el-avatar :size="36" :src="message.sender?.avatar || 'images/default-avatar.png'"></el-avatar>
                                                </div>
                                                <div class="message-content">
                                                    <div class="message-sender" v-if="currentChatRoom.is_group && message.sender_id !== userInfo.id">
                                                        {{ message.sender?.nickname || message.sender?.username }}
                                                    </div>
                                                    <div class="message-bubble">{{ message.content }}</div>
                                                    <div class="message-time">{{ formatTime(message.created_at) }}</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="chat-input">
                                        <el-input 
                                            v-model="messageContent" 
                                            type="textarea" 
                                            :rows="3"
                                            placeholder="输入消息..."
                                            @keyup.enter="sendMessage"></el-input>
                                        <el-button type="primary" @click="sendMessage" :disabled="!messageContent.trim()">
                                            发送
                                        </el-button>
                                    </div>
                                </template>
                                
                                <el-empty v-else description="选择一个聊天" />
                            </div>
                        </div>
                    </el-tab-pane>
                </el-tabs>
            </el-dialog>
            
            <!-- 添加好友对话框 -->
            <el-dialog v-model="showFriendRequestDialog" title="添加好友" width="30%">
                <el-form :model="friendRequestForm" label-width="80px">
                    <el-form-item label="用户ID">
                        <el-input v-model="friendRequestForm.receiverId" placeholder="输入用户ID"></el-input>
                    </el-form-item>
                    <el-form-item label="附言">
                        <el-input 
                            v-model="friendRequestForm.message" 
                            type="textarea" 
                            :rows="3"
                            placeholder="输入附言消息..."></el-input>
                    </el-form-item>
                </el-form>
                <template #footer>
                    <span class="dialog-footer">
                        <el-button @click="showFriendRequestDialog = false">取消</el-button>
                        <el-button type="primary" @click="sendFriendRequest" :disabled="!friendRequestForm.receiverId">
                            发送请求
                        </el-button>
                    </span>
                </template>
            </el-dialog>
            
            <!-- 创建聊天室对话框 -->
            <el-dialog v-model="showCreateChatRoomDialog" title="创建聊天" width="30%">
                <el-form :model="chatRoomForm" label-width="80px">
                    <el-form-item label="群聊名称">
                        <el-input v-model="chatRoomForm.name" placeholder="输入群聊名称"></el-input>
                    </el-form-item>
                    <el-form-item label="选择好友">
                        <el-select 
                            v-model="chatRoomForm.userIds" 
                            multiple 
                            placeholder="选择要添加的好友"
                            style="width: 100%">
                            <el-option 
                                v-for="friend in friendsList" 
                                :key="friend.id" 
                                :label="friend.nickname || friend.username" 
                                :value="friend.id">
                            </el-option>
                        </el-select>
                    </el-form-item>
                </el-form>
                <template #footer>
                    <span class="dialog-footer">
                        <el-button @click="showCreateChatRoomDialog = false">取消</el-button>
                        <el-button type="primary" @click="createChatRoom" :disabled="chatRoomForm.userIds.length === 0">
                            创建
                        </el-button>
                    </span>
                </template>
            </el-dialog>
        </div>
        `;

        // 创建Vue应用
        const app = createApp({
            template: appTemplate,
            setup() {
                // 基本状态
                const loading = ref(false);
                const currentView = ref('home');
                const activeTab = ref('home');
                const isLoggedIn = ref(false);
                const userInfo = ref(null);

                // 用户中心相关
                const userVideosLoading = ref(false);
                const userVideos = ref([]);
                const userCurrentPage = ref(1);
                const userPageSize = ref(12);
                const userTotal = ref(0);
                const profileForm = ref({
                    username: '',
                    nickname: '',
                    email: ''
                });
                const avatarUploading = ref(false);

                // 首页视频列表
                const homeLoading = ref(false);
                const homeVideos = ref([]);
                const homeCurrentPage = ref(1);
                const homePageSize = ref(12);
                const homeTotal = ref(0);

                // 热门视频列表
                const hotLoading = ref(false);
                const hotVideos = ref([]);
                const hotCurrentPage = ref(1);
                const hotPageSize = ref(12);
                const hotTotal = ref(0);
                const hotTimeRange = ref('week');

                // 关注视频列表
                const followLoading = ref(false);
                const followVideos = ref([]);
                const followCurrentPage = ref(1);
                const followPageSize = ref(12);
                const followTotal = ref(0);

                // 视频详情
                const showVideoDetail = ref(false);
                const currentVideo = ref({});
                const likeLoading = ref(false);

                // 评论相关
                const commentContent = ref('');
                const commentLoading = ref(false);
                const commentsLoading = ref(false);
                const comments = ref([]);
                const commentCurrentPage = ref(1);
                const commentPageSize = ref(20);
                const commentTotal = ref(0);
                const replyToComment = ref(null);
                const commentInput = ref(null);

                // 分享相关
                const shareDialogVisible = ref(false);
                const shareLink = ref('');

                // 视频上传相关
                const uploadDialogVisible = ref(false);
                const uploadStep = ref(1);
                const videoUploading = ref(false);
                const uploadProgress = ref(0);
                const publishLoading = ref(false);
                const videoForm = ref({
                    title: '',
                    description: '',
                    videoUrl: '',
                    coverUrl: '',
                    videoFile: null,
                    coverFile: null,
                    tags: []
                });
                const availableTags = ref(['娱乐', '游戏', '音乐', '电影', '动漫', '科技', '美食', '体育', '知识', '生活']);
                
                // 登录相关
                const loginDialogVisible = ref(false);
                const loginLoading = ref(false);
                const loginForm = ref({
                    username: '',
                    password: ''
                });
                const loginRules = {
                    username: [
                        { required: true, message: '请输入用户名', trigger: 'blur' },
                        { min: 3, max: 20, message: '长度在3到20个字符', trigger: 'blur' }
                    ],
                    password: [
                        { required: true, message: '请输入密码', trigger: 'blur' },
                        { min: 6, max: 20, message: '长度在6到20个字符', trigger: 'blur' }
                    ]
                };
                
                // 注册相关
                const registerDialogVisible = ref(false);
                const registerLoading = ref(false);
                const registerForm = ref({
                    username: '',
                    password: '',
                    confirmPassword: '',
                    email: '',
                    nickname: ''
                });
                const registerRules = {
                    username: [
                        { required: true, message: '请输入用户名', trigger: 'blur' },
                        { min: 3, max: 20, message: '长度在3到20个字符', trigger: 'blur' }
                    ],
                    password: [
                        { required: true, message: '请输入密码', trigger: 'blur' },
                        { min: 6, max: 20, message: '长度在6到20个字符', trigger: 'blur' }
                    ]
                };
                
                // 上传相关变量已在前面定义，这里只添加社交相关的变量
                
                // 社交相关
                const showSocialCenter = ref(false);
                const activeSocialTab = ref('friends');
                const friendsList = ref([]);
                const friendsLoading = ref(false);
                const friendsCurrentPage = ref(1);
                const friendsPageSize = ref(10);
                const friendsTotal = ref(0);
                
                const friendRequests = ref([]);
                const friendRequestsLoading = ref(false);
                
                const chatRooms = ref([]);
                const chatRoomsLoading = ref(false);
                const currentChatRoom = ref(null);
                const chatMessages = ref([]);
                const chatMessagesLoading = ref(false);
                const messageContent = ref('');
                const unreadMessageCount = ref(0);
                
                const showFriendRequestDialog = ref(false);
                const friendRequestForm = ref({
                    receiverId: '',
                    message: ''
                });
                
                const showCreateChatRoomDialog = ref(false);
                const chatRoomForm = ref({
                    name: '',
                    userIds: []
                });
                
                onMounted(() => {
                    // 检查登录状态
                    checkLoginStatus();
                    
                    // 移除令牌验证
                    // validateToken();
                    
                    // 从上次会话恢复状态
                    restoreLastSessionState();
                    
                    // 简单API测试
                    testApiConnection();
                    
                    // 加载首页视频
                    loadHomeVideos();
                    
                    // 根据路径参数加载视频详情
                    const urlParams = new URLSearchParams(window.location.search);
                    const videoId = urlParams.get('video_id');
                    if (videoId) {
                        goToVideo(videoId);
                    }
                });

                // 加载首页视频
                async function loadHomeVideos() {
                    try {
                        homeLoading.value = true;
                        const res = await apiService.video.getList(homeCurrentPage.value, homePageSize.value);
                        homeVideos.value = res.data.videos || [];
                        homeTotal.value = res.data.total || 0;
                    } catch (error) {
                        console.error('加载首页视频失败:', error);
                        homeVideos.value = [];
                    } finally {
                        homeLoading.value = false;
                    }
                }

                // 加载热门视频
                async function loadHotVideos() {
                    try {
                        hotLoading.value = true;
                        const res = await apiService.video.getHotList(hotCurrentPage.value, hotPageSize.value, hotTimeRange.value);
                        hotVideos.value = res.data.videos || [];
                        hotTotal.value = res.data.total || 0;
                    } catch (error) {
                        console.error('加载热门视频失败:', error);
                        hotVideos.value = [];
                    } finally {
                        hotLoading.value = false;
                    }
                }

                // 加载关注视频
                async function loadFollowVideos() {
                    if (!isLoggedIn.value) return;
                    
                    try {
                        followLoading.value = true;
                        const res = await apiService.video.getFollowedVideos(followCurrentPage.value, followPageSize.value);
                        followVideos.value = res.data.videos || [];
                        followTotal.value = res.data.total || 0;
                    } catch (error) {
                        console.error('加载关注视频失败:', error);
                        followVideos.value = [];
                    } finally {
                        followLoading.value = false;
                    }
                }

                // 切换标签页
                function switchTab(tab) {
                    activeTab.value = tab;
                    currentView.value = tab;
                    
                    // 如果是"关注"标签，需要检查登录状态
                    if (tab === 'follow') {
                        if (!isLoggedIn.value) {
                            ElMessage.warning('请先登录');
                            showLoginDialog();
                            return;
                        }
                        loadFollowVideos();
                    } else if (tab === 'hot' && hotVideos.value.length === 0) {
                        loadHotVideos();
                    }
                }
                
                // 前往视频详情页
                async function goToVideo(videoId) {
                    try {
                        loading.value = true;
                        const res = await apiService.video.getVideoDetail(videoId);
                        currentVideo.value = res.data.video || {};
                        
                        // 加载视频评论
                        loadComments(videoId);
                        
                        // 更新浏览量
                        apiService.video.incrementView(videoId).catch(error => {
                            console.error('更新浏览量失败:', error);
                        });
                        
                        // 更新分享链接
                        shareLink.value = window.location.origin + window.location.pathname + '?video_id=' + videoId;
                        
                        // 显示视频详情
                        showVideoDetail.value = true;
                        
                        // 更新URL，不刷新页面
                        const url = new URL(window.location);
                        url.searchParams.set('video_id', videoId);
                        window.history.pushState({}, '', url);
                    } catch (error) {
                        console.error('获取视频详情失败:', error);
                        ElMessage.error('获取视频详情失败');
                    } finally {
                        loading.value = false;
                    }
                }

                // 关闭视频详情页
                function closeVideoDetail() {
                    showVideoDetail.value = false;
                    
                    // 清除URL参数
                    const url = new URL(window.location);
                    url.searchParams.delete('video_id');
                    window.history.pushState({}, '', url);
                    
                    // 暂停视频播放
                    if (document.querySelector('video')) {
                        document.querySelector('video').pause();
                    }
                }

                // 加载视频评论
                async function loadComments(videoId) {
                    try {
                        commentsLoading.value = true;
                        const res = await apiService.interaction.getComments(videoId, commentCurrentPage.value, commentPageSize.value);
                        comments.value = res.data.comments || [];
                        commentTotal.value = res.data.total || 0;
                    } catch (error) {
                        console.error('加载评论失败:', error);
                        comments.value = [];
                    } finally {
                        commentsLoading.value = false;
                    }
                }

                // 视频点赞
                async function likeVideo(videoId) {
                    if (!isLoggedIn.value) {
                        showLoginDialog();
                        return;
                    }
                    
                    try {
                        likeLoading.value = true;
                        await apiService.interaction.like(videoId);
                        
                        // 更新点赞状态
                        currentVideo.value.is_liked = !currentVideo.value.is_liked;
                        if (currentVideo.value.is_liked) {
                            currentVideo.value.like_count++;
                        } else {
                            currentVideo.value.like_count--;
                        }
                        
                        ElMessage.success(currentVideo.value.is_liked ? '点赞成功' : '已取消点赞');
                    } catch (error) {
                        console.error('点赞操作失败:', error);
                    } finally {
                        likeLoading.value = false;
                    }
                }

                // 发表评论
                async function submitComment() {
                    if (!isLoggedIn.value) {
                        showLoginDialog();
                        return;
                    }
                    
                    if (!commentContent.value.trim()) {
                        ElMessage.warning('评论内容不能为空');
                        return;
                    }
                    
                    try {
                        commentLoading.value = true;
                        
                        console.log('开始发表评论...');
                        
                        const token = localStorage.getItem('token');
                        let url, data;
                        
                        // 如果是回复评论
                        if (replyToComment.value) {
                            url = `${API_BASE_URL}/interaction/comment`;
                            data = {
                                video_id: currentVideo.value.id,
                                content: commentContent.value,
                                parent_id: replyToComment.value.id
                            };
                        } else {
                            url = `${API_BASE_URL}/interaction/comment`;
                            data = {
                                video_id: currentVideo.value.id,
                                content: commentContent.value
                            };
                        }
                        
                        // 使用独立的axios实例，避免全局拦截器的影响
                        const axiosInstance = axios.create();
                        const response = await axiosInstance({
                            method: 'post',
                            url: url,
                            data: data,
                            headers: {
                                'Authorization': `Bearer ${token}`
                            }
                        });
                        
                        console.log('评论提交响应:', response);
                        
                        // 重新加载评论列表
                        loadComments(currentVideo.value.id);
                        
                        // 清空输入框
                        commentContent.value = '';
                        replyToComment.value = null;
                        
                        // 更新评论数
                        currentVideo.value.comment_count++;
                        
                        ElMessage.success('评论发表成功');
                    } catch (error) {
                        console.error('评论发表失败:', error);
                        
                        // 详细记录错误信息
                        if (error.response) {
                            console.error('错误响应数据:', error.response.data);
                            console.error('错误状态码:', error.response.status);
                        } else if (error.request) {
                            console.error('请求发送但未收到响应');
                        } else {
                            console.error('请求配置错误:', error.message);
                        }
                        
                        // 不显示特定错误，统一处理
                        ElMessage.error('评论发表失败，请重试');
                    } finally {
                        commentLoading.value = false;
                    }
                }

                // 回复评论
                function replyComment(comment, parentId = null) {
                    if (!isLoggedIn.value) {
                        showLoginDialog();
                        return;
                    }
                    
                    replyToComment.value = {
                        id: parentId || comment.id,
                        nickname: comment.user.nickname
                    };
                    
                    commentContent.value = '@' + comment.user.nickname + ' ';
                    focusCommentInput();
                }

                // 聚焦评论输入框
                function focusCommentInput() {
                    setTimeout(() => {
                        if (commentInput.value) {
                            commentInput.value.focus();
                        }
                    }, 100);
                }

                // 删除评论
                async function deleteComment(commentId) {
                    if (!isLoggedIn.value) {
                        return;
                    }
                    
                    try {
                        await ElMessageBox.confirm('确定要删除这条评论吗？', '提示', {
                            confirmButtonText: '确定',
                            cancelButtonText: '取消',
                            type: 'warning'
                        });
                        
                        await apiService.interaction.deleteComment(commentId);
                        
                        // 重新加载评论列表
                        loadComments(currentVideo.value.id);
                        
                        // 更新评论数
                        currentVideo.value.comment_count--;
                        
                        ElMessage.success('评论已删除');
                    } catch (error) {
                        if (error !== 'cancel') {
                            console.error('删除评论失败:', error);
                        }
                    }
                }

                // 点赞评论
                async function likeComment(commentId) {
                    if (!isLoggedIn.value) {
                        showLoginDialog();
                        return;
                    }
                    
                    try {
                        await apiService.interaction.likeComment(commentId);
                        
                        // 更新点赞状态和数量 (简单处理，实际应该按ID查找更新)
                        const updateComment = (list) => {
                            for (let i = 0; i < list.length; i++) {
                                if (list[i].id === commentId) {
                                    list[i].is_liked = !list[i].is_liked;
                                    if (list[i].is_liked) {
                                        list[i].like_count++;
                                    } else {
                                        list[i].like_count--;
                                    }
                                    return true;
                                }
                                
                                if (list[i].children) {
                                    if (updateComment(list[i].children)) {
                                        return true;
                                    }
                                }
                            }
                            return false;
                        };
                        
                        updateComment(comments.value);
                    } catch (error) {
                        console.error('点赞评论失败:', error);
                    }
                }

                // 分享视频
                function shareVideo() {
                    shareDialogVisible.value = true;
                }

                // 复制分享链接
                function copyShareLink() {
                    navigator.clipboard.writeText(shareLink.value)
                        .then(() => {
                            ElMessage.success('链接已复制');
                        })
                        .catch(err => {
                            console.error('复制失败:', err);
                            ElMessage.error('复制失败');
                        });
                }

                // 分享到社交平台
                function shareToQQ() {
                    const url = `https://connect.qq.com/widget/shareqq/index.html?url=${encodeURIComponent(shareLink.value)}&title=${encodeURIComponent(currentVideo.value.title)}`;
                    window.open(url);
                }
                
                function shareToWechat() {
                    ElMessage.info('请使用微信扫一扫功能扫描页面二维码');
                }
                
                function shareToWeibo() {
                    const url = `https://service.weibo.com/share/share.php?url=${encodeURIComponent(shareLink.value)}&title=${encodeURIComponent(currentVideo.value.title)}`;
                    window.open(url);
                }

                // 显示上传对话框
                function showUploadDialog() {
                    if (!isLoggedIn.value) {
                        showLoginDialog();
                        return;
                    }
                    
                    uploadDialogVisible.value = true;
                    uploadStep.value = 1;
                    videoForm.value = {
                        title: '',
                        description: '',
                        videoUrl: '',
                        coverUrl: '',
                        videoFile: null,
                        coverFile: null,
                        tags: []
                    };
                }

                // 上传前检查
                function beforeVideoUpload(file) {
                    const isLt500M = file.size / 1024 / 1024 < 500;
                    if (!isLt500M) {
                        ElMessage.error('视频大小不能超过500MB');
                    }
                    return isLt500M;
                }

                // 处理视频上传
                function handleVideoUpload(options) {
                    const { file } = options;
                    videoUploading.value = true;
                    uploadProgress.value = 0;
                    
                    // 存储文件，在发布时一起上传
                    videoForm.value.videoFile = file;
                    videoForm.value.title = file.name.replace(/\.[^/.]+$/, "");
                    
                    // 创建本地URL供预览
                    videoForm.value.videoUrl = URL.createObjectURL(file);
                    
                    // 模拟上传进度（仅用于UI体验）
                    const interval = setInterval(() => {
                        if (uploadProgress.value < 95) {
                            uploadProgress.value += parseInt(Math.random() * 10);
                        }
                    }, 300);
                    
                    // 模拟处理过程
                    setTimeout(() => {
                        clearInterval(interval);
                        uploadProgress.value = 100;
                        videoUploading.value = false;
                        ElMessage.success('视频准备就绪');
                        
                        // 转到第二步
                        setTimeout(() => {
                            uploadStep.value = 2;
                        }, 500);
                    }, 1500);
                }

                // 处理封面上传
                function handleCoverUpload(options) {
                    const { file } = options;
                    
                    // 存储封面文件，在发布时一起上传
                    videoForm.value.coverFile = file;
                    
                    // 创建本地URL供预览
                    videoForm.value.coverUrl = URL.createObjectURL(file);
                    ElMessage.success('封面准备就绪');
                }

                // 进入下一步
                function nextStep() {
                    uploadStep.value = 2;
                }

                // 取消上传
                function cancelUpload() {
                    uploadDialogVisible.value = false;
                    
                    // 释放对象URL
                    if (videoForm.value.videoUrl && videoForm.value.videoUrl.startsWith('blob:')) {
                        URL.revokeObjectURL(videoForm.value.videoUrl);
                    }
                    if (videoForm.value.coverUrl && videoForm.value.coverUrl.startsWith('blob:')) {
                        URL.revokeObjectURL(videoForm.value.coverUrl);
                    }
                    
                    // 重置表单
                    videoForm.value = {
                        title: '',
                        description: '',
                        videoUrl: '',
                        coverUrl: '',
                        videoFile: null,
                        coverFile: null,
                        tags: []
                    };
                }

                // 发布视频
                async function publishVideo() {
                    if (!videoForm.value.title.trim()) {
                        ElMessage.warning('请输入视频标题');
                        return;
                    }
                    
                    if (!videoForm.value.videoFile) {
                        ElMessage.warning('请先上传视频');
                        return;
                    }
                    
                    try {
                        publishLoading.value = true;
                        
                        console.log('开始发布视频...');
                        
                        // 创建FormData对象
                        const formData = new FormData();
                        formData.append('title', videoForm.value.title);
                        formData.append('description', videoForm.value.description || '');
                        formData.append('video', videoForm.value.videoFile);
                        
                        // 如果有封面，也添加到表单
                        if (videoForm.value.coverFile) {
                            formData.append('cover', videoForm.value.coverFile);
                        }
                        
                        // 添加标签
                        if (videoForm.value.tags && videoForm.value.tags.length > 0) {
                            formData.append('tags', JSON.stringify(videoForm.value.tags));
                        }
                        
                        // 使用独立的axios实例发送请求，避免全局拦截器的干扰
                        const token = localStorage.getItem('token');
                        const axiosInstance = axios.create();
                        const response = await axiosInstance({
                            method: 'post',
                            url: `${API_BASE_URL}/video/publish`,
                            data: formData,
                            headers: { 
                                'Content-Type': 'multipart/form-data',
                                'Authorization': `Bearer ${token}`
                            }
                        });
                        
                        console.log('视频发布响应:', response);
                        
                        ElMessage.success('视频发布成功，审核通过后将会显示');
                        
                        // 关闭对话框
                        uploadDialogVisible.value = false;
                        
                        // 释放对象URL
                        if (videoForm.value.videoUrl && videoForm.value.videoUrl.startsWith('blob:')) {
                            URL.revokeObjectURL(videoForm.value.videoUrl);
                        }
                        if (videoForm.value.coverUrl && videoForm.value.coverUrl.startsWith('blob:')) {
                            URL.revokeObjectURL(videoForm.value.coverUrl);
                        }
                        
                        // 重置表单
                        videoForm.value = {
                            title: '',
                            description: '',
                            videoUrl: '',
                            coverUrl: '',
                            videoFile: null,
                            coverFile: null,
                            tags: []
                        };
                        
                        // 重新加载首页视频
                        loadHomeVideos();
                        
                        // 如果在用户中心，也重新加载用户视频
                        if (currentView.value === 'user') {
                            loadUserVideos();
                        }
                    } catch (error) {
                        console.error('视频发布失败:', error);
                        
                        // 详细记录错误信息
                        if (error.response) {
                            console.error('错误响应数据:', error.response.data);
                            console.error('错误状态码:', error.response.status);
                        } else if (error.request) {
                            console.error('请求发送但未收到响应');
                        } else {
                            console.error('请求配置错误:', error.message);
                        }
                        
                        // 统一错误处理，不区分401等情况
                        ElMessage.error('视频发布失败，请重试');
                        
                    } finally {
                        publishLoading.value = false;
                    }
                }
                
                // 格式化数字
                function formatNumber(num) {
                    if (num === undefined || num === null) return '0';
                    if (num < 1000) return num.toString();
                    if (num < 10000) return (num / 1000).toFixed(1) + 'K';
                    return (num / 10000).toFixed(1) + 'W';
                }
                
                // 格式化时间
                function formatTime(timestamp) {
                    if (!timestamp) return '';
                    
                    const date = new Date(timestamp);
                    const now = new Date();
                    const diff = Math.floor((now - date) / 1000);
                    
                    if (diff < 60) return '刚刚';
                    if (diff < 3600) return Math.floor(diff / 60) + '分钟前';
                    if (diff < 86400) return Math.floor(diff / 3600) + '小时前';
                    if (diff < 2592000) return Math.floor(diff / 86400) + '天前';
                    
                    return date.getFullYear() + '-' + 
                           padZero(date.getMonth() + 1) + '-' + 
                           padZero(date.getDate());
                }
                
                function padZero(num) {
                    return num < 10 ? '0' + num : num;
                }
                
                // 格式化视频时长
                function formatDuration(seconds) {
                    if (!seconds) return '00:00';
                    
                    const mins = Math.floor(seconds / 60);
                    const secs = Math.floor(seconds % 60);
                    
                    return padZero(mins) + ':' + padZero(secs);
                }
                
                // 检查登录状态
                function checkLoginStatus() {
                    const token = localStorage.getItem('token');
                    const userInfoStr = localStorage.getItem('userInfo');
                    
                    if (token && userInfoStr) {
                        try {
                            // 直接使用后端返回的用户信息，包括头像路径
                            userInfo.value = JSON.parse(userInfoStr);
                            
                            // 确保avatar属性存在
                            if (userInfo.value && !userInfo.value.avatar && userInfo.value.avatar_url) {
                                userInfo.value.avatar = userInfo.value.avatar_url;
                            }
                            
                            isLoggedIn.value = true;
                        } catch (error) {
                            console.error('解析用户信息失败:', error);
                            localStorage.removeItem('token');
                            localStorage.removeItem('userInfo');
                            isLoggedIn.value = false;
                            userInfo.value = null;
                        }
                    }
                }
                
                // 显示登录对话框
                function showLoginDialog() {
                    loginDialogVisible.value = true;
                }
                
                // 显示注册对话框
                function showRegisterDialog() {
                    registerDialogVisible.value = true;
                }
                
                // 从登录切换到注册
                function switchToRegister() {
                    loginDialogVisible.value = false;
                    showRegisterDialog();
                }
                
                // 从注册切换到登录
                function switchToLogin() {
                    registerDialogVisible.value = false;
                    showLoginDialog();
                }
                
                // 登录
                async function login() {
                    try {
                        loginLoading.value = true;
                        const res = await apiService.user.login(loginForm.value.username, loginForm.value.password);
                        
                        // 取得后端返回的用户数据
                        const userData = res.data;
                        const token = userData.token;
                        const refreshToken = userData.refresh_token;
                        
                        // 确保用户数据中包含头像URL
                        const userInfo = {
                            id: userData.id,
                            username: userData.username,
                            nickname: userData.nickname,
                            avatar: userData.avatar_url,  // 直接使用后端返回的头像URL
                            created_at: userData.created_at,
                            updated_at: userData.updated_at
                        };
                        
                        // 存储令牌和用户信息
                        localStorage.setItem('token', token);
                        if (refreshToken) {
                            localStorage.setItem('refreshToken', refreshToken);
                        }
                        localStorage.setItem('userInfo', JSON.stringify(userInfo));
                        
                        // 更新状态
                        isLoggedIn.value = true;
                        userInfo.value = userInfo;
                        
                        // 关闭对话框
                        loginDialogVisible.value = false;
                        
                        // 重置表单
                        loginForm.value = {
                            username: '',
                            password: ''
                        };
                        
                        ElMessage.success('登录成功');
                        
                        // 恢复上次会话状态
                        restoreLastSessionState();
                        
                        // 如果是关注页面，加载关注视频
                        if (currentView.value === 'follow') {
                            loadFollowVideos();
                        }
                    } catch (error) {
                        console.error('登录失败:', error);
                        // 错误消息会由axios拦截器处理
                    } finally {
                        loginLoading.value = false;
                    }
                }
                
                // 注册
                async function register() {
                    if (registerForm.value.password !== registerForm.value.confirmPassword) {
                        ElMessage.error('两次输入的密码不一致');
                        return;
                    }
                    
                    try {
                        registerLoading.value = true;
                        
                        const userData = {
                            username: registerForm.value.username,
                            password: registerForm.value.password,
                            email: registerForm.value.email || undefined,
                            nickname: registerForm.value.nickname || undefined
                        };
                        
                        const res = await apiService.user.register(userData);
                        
                        // 取得后端返回的数据
                        const responseData = res.data;
                        const token = responseData.token;
                        const refreshToken = responseData.refresh_token;
                        
                        // 构建用户信息对象
                        const userInfo = {
                            id: responseData.user_id || responseData.id,
                            username: registerForm.value.username,
                            nickname: registerForm.value.nickname,
                            avatar: responseData.avatar_url,  // 直接使用后端返回的头像URL
                            created_at: new Date().getTime()
                        };
                        
                        // 存储令牌和用户信息
                        localStorage.setItem('token', token);
                        if (refreshToken) {
                            localStorage.setItem('refreshToken', refreshToken);
                        }
                        localStorage.setItem('userInfo', JSON.stringify(userInfo));
                        
                        // 更新状态
                        isLoggedIn.value = true;
                        userInfo.value = userInfo;
                        
                        // 关闭对话框
                        registerDialogVisible.value = false;
                        
                        // 重置表单
                        registerForm.value = {
                            username: '',
                            password: '',
                            confirmPassword: '',
                            email: '',
                            nickname: ''
                        };
                        
                        ElMessage.success('注册成功');
                    } catch (error) {
                        console.error('注册失败:', error);
                        // 错误消息会由axios拦截器处理
                    } finally {
                        registerLoading.value = false;
                    }
                }
                
                // 退出登录
                function logout(showMessage = true) {
                    localStorage.removeItem('token');
                    localStorage.removeItem('refreshToken');
                    localStorage.removeItem('userInfo');
                    isLoggedIn.value = false;
                    userInfo.value = null;
                    
                    if (currentView.value === 'follow') {
                        currentView.value = 'home';
                        activeTab.value = 'home';
                    }
                    
                    if (showMessage) {
                        ElMessage.success('已退出登录');
                    }
                }
                
                // 前往用户中心
                function goToUserCenter() {
                    if (!isLoggedIn.value) {
                        showLoginDialog();
                        return;
                    }
                    
                    currentView.value = 'user';
                    loadUserVideos();
                    
                    // 加载用户资料到表单
                    profileForm.value = {
                        username: userInfo.value?.username || '',
                        nickname: userInfo.value?.nickname || '',
                        email: userInfo.value?.email || ''
                    };
                }
                
                // 加载用户视频
                async function loadUserVideos() {
                    if (!isLoggedIn.value || !userInfo.value) return;
                    
                    try {
                        userVideosLoading.value = true;
                        console.log('开始加载用户视频，用户ID:', userInfo.value.id);
                        const res = await apiService.video.getUserVideos(userInfo.value.id, userCurrentPage.value, userPageSize.value);
                        console.log('用户视频加载响应:', res);
                        
                        // 检查响应格式，适配不同的返回结构
                        if (res.data && res.data.items) {
                            userVideos.value = res.data.items;
                            userTotal.value = res.data.total || 0;
                        } else if (res.data && res.data.videos) {
                            userVideos.value = res.data.videos;
                            userTotal.value = res.data.total || 0;
                        } else {
                            userVideos.value = [];
                            userTotal.value = 0;
                            console.warn('用户视频响应格式不符合预期:', res.data);
                        }
                    } catch (error) {
                        console.error('加载用户视频失败:', error);
                        userVideos.value = [];
                    } finally {
                        userVideosLoading.value = false;
                    }
                }
                
                // 处理头像上传
                async function handleAvatarUpload(options) {
                    if (!isLoggedIn.value) {
                        showLoginDialog();
                        return;
                    }
                    
                    try {
                        avatarUploading.value = true;
                        const { file } = options;
                        
                        // 创建表单数据
                        const formData = new FormData();
                        formData.append('avatar', file);
                        
                        console.log('开始上传头像...');
                        
                        // 使用标准axios请求，直接处理原始响应
                        const token = localStorage.getItem('token');
                        
                        // 使用axios实例创建请求，避免拦截器可能的影响
                        const axiosInstance = axios.create();
                        const response = await axiosInstance({
                            method: 'post',
                            url: `${API_BASE_URL}/user/avatar`,
                            data: formData,
                            headers: { 
                                'Content-Type': 'multipart/form-data',
                                'Authorization': `Bearer ${token}`
                            }
                        });
                        
                        console.log('头像上传响应:', response);
                        
                        // 直接从响应中获取头像URL
                        if (response && response.data && response.data.data && response.data.data.avatar_url) {
                            // 直接使用后端返回的头像URL
                            const avatarUrl = response.data.data.avatar_url;
                            console.log('获取到头像URL:', avatarUrl);
                            
                            // 防止可能的引用错误
                            if (!userInfo.value) {
                                userInfo.value = {};
                            }
                            
                            // 更新头像
                            userInfo.value.avatar = avatarUrl;
                            
                            // 更新本地存储的用户信息
                            localStorage.setItem('userInfo', JSON.stringify(userInfo.value));
                            
                            ElMessage.success('头像上传成功');
                        } else {
                            console.warn('响应中未找到头像URL:', response.data);
                            ElMessage.warning('头像已上传，但无法获取URL，请刷新页面查看效果');
                        }
                    } catch (error) {
                        console.error('头像上传失败:', error);
                        
                        // 详细记录错误信息
                        if (error.response) {
                            console.error('错误响应数据:', error.response.data);
                            console.error('错误状态码:', error.response.status);
                        } else if (error.request) {
                            console.error('请求发送但未收到响应');
                        } else {
                            console.error('请求配置错误:', error.message);
                        }
                        
                        ElMessage.error('头像上传失败，请重试');
                    } finally {
                        avatarUploading.value = false;
                    }
                }
                
                // 更新用户资料
                async function updateProfile() {
                    ElMessage.info('更新用户资料功能开发中...');
                    // 实际项目中应该调用API更新用户资料
                }
                
                // 前往用户页面
                function goToUser(userId) {
                    if (isLoggedIn.value && userInfo.value && userId === userInfo.value.id) {
                        goToUserCenter();
                    } else {
                        // 实际项目中应该跳转到用户个人页
                        ElMessage.info('访问其他用户功能开发中...');
                    }
                }
                
                // 处理首页分页
                function handleHomePageChange(page) {
                    homeCurrentPage.value = page;
                    loadHomeVideos();
                }
                
                // 处理热门分页
                function handleHotPageChange(page) {
                    hotCurrentPage.value = page;
                    loadHotVideos();
                }
                
                // 处理关注分页
                function handleFollowPageChange(page) {
                    followCurrentPage.value = page;
                    loadFollowVideos();
                }
                
                // 处理评论分页
                function handleCommentPageChange(page) {
                    commentCurrentPage.value = page;
                    loadComments(currentVideo.value.id);
                }
                
                // 视频播放事件
                function onVideoTimeUpdate() {
                    // 可以在这里记录播放进度
                }
                
                function onVideoEnded() {
                    // 视频播放结束事件
                    console.log('视频播放结束');
                }

                // 测试API连接
                async function testApiConnection() {
                    try {
                        console.log('正在测试API连接...');
                        const testUrl = `${API_BASE_URL}/ping`;
                        console.log('测试URL:', testUrl);
                        
                        const response = await axios.get(testUrl, { timeout: 5000 });
                        console.log('API测试成功:', response);
                        ElMessage.success('后端连接正常');
                    } catch (error) {
                        console.error('API测试失败:', error);
                        ElMessage.error('后端连接测试失败，详情请查看控制台');
                    }
                }

                // 处理用户视频分页
                function handleUserPageChange(page) {
                    userCurrentPage.value = page;
                    loadUserVideos();
                }

                // 验证令牌有效性 - 移除此功能
                async function validateToken() {
                    // 前端不再验证令牌
                    console.log('前端不再验证令牌有效性');
                    return;
                }
                
                // 恢复上次会话状态
                function restoreLastSessionState() {
                    // 检查是否有上次页面记录
                    const lastPage = sessionStorage.getItem('lastPage');
                    if (lastPage) {
                        try {
                            const url = new URL(lastPage);
                            const videoId = url.searchParams.get('video_id');
                            if (videoId) {
                                // 恢复到视频详情页
                                goToVideo(videoId);
                            }
                            
                            // 清除会话存储中的记录
                            sessionStorage.removeItem('lastPage');
                        } catch (error) {
                            console.error('解析上次页面URL失败:', error);
                        }
                    }
                    
                    // 移除令牌过期处理
                    sessionStorage.removeItem('tokenExpired');
                }

                // 处理头像URL的全局函数
                function getAvatarUrl(avatarPath) {
                    if (!avatarPath) return 'http://localhost:8080/avatars/default.jpg';
                    
                    // 如果已经是完整的URL，直接返回
                    if (avatarPath.startsWith('http')) {
                        return avatarPath;
                    }
                    
                    // 确保路径以/开头
                    if (!avatarPath.startsWith('/')) {
                        avatarPath = '/' + avatarPath;
                    }
                    
                    return `${window.location.origin}${avatarPath}`;
                }
                
                // 处理媒体文件URL的全局函数（视频、封面等）
                function getMediaUrl(mediaPath, type = 'video') {
                    if (!mediaPath) return '';
                    
                    // 如果是Blob URL或完整URL，直接返回
                    if (mediaPath.startsWith('blob:') || mediaPath.startsWith('http')) {
                        return mediaPath;
                    }
                    
                    // 确保路径以/开头
                    if (!mediaPath.startsWith('/')) {
                        mediaPath = '/' + mediaPath;
                    }
                    
                    return `${window.location.origin}${mediaPath}`;
                }

                return {
                    loading,
                    currentView,
                    activeTab,
                    isLoggedIn,
                    userInfo,
                    homeLoading,
                    homeVideos,
                    homeCurrentPage,
                    homePageSize,
                    homeTotal,
                    hotLoading,
                    hotVideos,
                    hotCurrentPage,
                    hotPageSize,
                    hotTotal,
                    hotTimeRange,
                    followLoading,
                    followVideos,
                    followCurrentPage,
                    followPageSize,
                    followTotal,
                    showVideoDetail,
                    currentVideo,
                    likeLoading,
                    commentContent,
                    commentLoading,
                    commentsLoading,
                    comments,
                    commentCurrentPage,
                    commentPageSize,
                    commentTotal,
                    commentInput,
                    shareDialogVisible,
                    shareLink,
                    uploadDialogVisible,
                    uploadStep,
                    videoUploading,
                    uploadProgress,
                    publishLoading,
                    videoForm,
                    availableTags,
                    loginDialogVisible,
                    loginLoading,
                    loginForm,
                    loginRules,
                    registerDialogVisible,
                    registerLoading,
                    registerForm,
                    registerRules,
                    userVideosLoading,
                    userVideos,
                    userCurrentPage,
                    userPageSize,
                    userTotal,
                    profileForm,
                    avatarUploading,
                    switchTab,
                    loadHomeVideos,
                    loadHotVideos,
                    loadFollowVideos,
                    goToVideo,
                    closeVideoDetail,
                    likeVideo,
                    submitComment,
                    replyComment,
                    focusCommentInput,
                    deleteComment,
                    likeComment,
                    shareVideo,
                    copyShareLink,
                    shareToQQ,
                    shareToWechat,
                    shareToWeibo,
                    showUploadDialog,
                    beforeVideoUpload,
                    handleVideoUpload,
                    handleCoverUpload,
                    nextStep,
                    cancelUpload,
                    publishVideo,
                    formatNumber,
                    formatTime,
                    formatDuration,
                    showLoginDialog,
                    showRegisterDialog,
                    switchToRegister,
                    switchToLogin,
                    login,
                    register,
                    logout,
                    goToUserCenter,
                    loadUserVideos,
                    handleAvatarUpload,
                    updateProfile,
                    goToUser,
                    handleHomePageChange,
                    handleHotPageChange,
                    handleFollowPageChange,
                    handleCommentPageChange,
                    onVideoTimeUpdate,
                    onVideoEnded,
                    testApiConnection,
                    handleUserPageChange,
                    validateToken,
                    restoreLastSessionState,
                    getAvatarUrl,
                    getMediaUrl
                };
            }
        });

        // 组件注册
        for (const [name, component] of Object.entries(iconComponents)) {
            app.component(name.toLowerCase(), component);
        }

        // 初始化
        app.use(ElementPlus);
        app.mount('#app');
    </script>
</body>
</html> 